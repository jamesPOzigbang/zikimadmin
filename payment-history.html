<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€í‚´ì§„ë‹¨ ê´€ë¦¬ì - ì´ìš©ê¶Œ í˜„í™©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            /* Colors */
            --primary-color: #009720;
            --primary-light: #009720;
            --accent-color: #009720;
            --bg-color: #F8FAFC;
            --card-bg: #FFFFFF;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --border-color: #E2E8F0;
        }

        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        /* Sidebar Styles */
        .sidebar-link.active {
            background-color: rgba(0, 151, 32, 0.1);
            color: var(--primary-color);
        }
    </style>
</head>

<body>
    <div class="app-container">

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-area">
                <img src="logo.png" class="logo-icon" alt="Logo">
                <span class="logo-text">ì§€í‚´ì§„ë‹¨ Admin</span>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    <span class="icon">ğŸ“„</span>
                    ë¦¬í¬íŠ¸ ë°œê¸‰ ì´ë ¥
                </a>
                <a href="content-management-standalone.html" class="nav-item">
                    <span class="icon">âš™ï¸</span>
                    ì»¨í…ì¸  ê´€ë¦¬
                </a>
                <a href="payment-history.html" class="nav-item active">
                    <span class="icon">ğŸ’³</span>
                    ì´ìš©ê¶Œ í˜„í™©
                </a>

            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="h-16 border-b bg-white flex items-center justify-between px-8 flex-shrink-0">
                <div class="text-sm text-gray-500">
                    <span>í™ˆ</span> / <span class="font-medium text-gray-900">ì´ìš©ê¶Œ í˜„í™©</span>
                </div>
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 rounded-full bg-[#009720] flex items-center justify-center text-white text-xs font-bold">
                        AD
                    </div>
                    <span class="text-sm font-medium">ê´€ë¦¬ì</span>
                </div>
            </header>

            <!-- Page Content -->
            <main class="flex-1 overflow-y-auto bg-gray-50 p-8">
                <div class="max-w-7xl mx-auto space-y-6">
                    <div>
                        <h1 class="text-2xl font-bold mb-1 text-gray-900">ì´ìš©ê¶Œ í˜„í™©</h1>
                        <p class="text-gray-500">ê³ ê°ì˜ ì´ìš©ê¶Œ êµ¬ë§¤ ë‚´ì—­ ë° ì”ì—¬ íšŸìˆ˜ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.</p>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">ê³ ê° ì •ë³´</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="filter-email" placeholder="ì´ë©”ì¼ ê²€ìƒ‰"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#009720] focus:border-transparent">
                                    <input type="text" id="filter-phone" placeholder="ì „í™”ë²ˆí˜¸ ê²€ìƒ‰"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#009720] focus:border-transparent">
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">êµ¬ë§¤ê¸°ê°„</label>
                                <div class="flex items-center gap-2">
                                    <input type="date" id="filter-date-start"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#009720] focus:border-transparent">
                                    <span class="text-gray-500">~</span>
                                    <input type="date" id="filter-date-end"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#009720] focus:border-transparent">
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">êµ¬ë§¤ë‚´ì—­</label>
                                <select id="filter-item"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#009720] focus:border-transparent">
                                    <option value="all">ì „ì²´</option>
                                    <option value="free">ë¬´ë£Œ 1íšŒì›</option>
                                    <option value="1pass">1íšŒ ì´ìš©ê¶Œ</option>
                                    <option value="5pass">5íšŒ ì´ìš©ê¶Œ</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">ê²°ì œ ìƒíƒœ</label>
                                <select id="filter-status"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#009720] focus:border-transparent">
                                    <option value="all">ì „ì²´</option>
                                    <option value="completed">ì™„ë£Œ</option>
                                    <option value="failed">ì‹¤íŒ¨</option>
                                    <option value="refund_requested">í™˜ë¶ˆ ì‹ ì²­</option>
                                    <option value="refunded">í™˜ë¶ˆ ì™„ë£Œ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Status Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-sm font-medium text-gray-500 mb-1">ê¸°ê°„ì¤‘ ìœ ë£Œ êµ¬ë§¤ìˆ˜</h3>
                            <p class="text-2xl font-bold text-gray-900" id="stat-paid">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-sm font-medium text-gray-500 mb-1">ë¬´ë£Œ ë°œê¸‰ìˆ˜</h3>
                            <p class="text-2xl font-bold text-gray-900" id="stat-free">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-sm font-medium text-gray-500 mb-1">í™˜ë¶ˆ ì‹ ì²­ìˆ˜</h3>
                            <p class="text-2xl font-bold text-orange-600" id="stat-refund-req">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-sm font-medium text-gray-500 mb-1">í™˜ë¶ˆ ì™„ë£Œìˆ˜</h3>
                            <p class="text-2xl font-bold text-gray-500" id="stat-refunded">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-sm font-medium text-gray-500 mb-1">ì‹¤íŒ¨ìˆ˜</h3>
                            <p class="text-2xl font-bold text-red-600" id="stat-failed">0</p>
                        </div>
                    </div>



                    <!-- Table -->
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="px-6 py-3 font-medium text-gray-500">ê³ ê° ì´ë©”ì¼</th>
                                        <th class="px-6 py-3 font-medium text-gray-500">ê³ ê° ì „í™”ë²ˆí˜¸</th>
                                        <th class="px-6 py-3 font-medium text-gray-500">êµ¬ë§¤ì¼ì‹œ</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ìƒí’ˆëª…</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ì”ì—¬ / í™˜ë¶ˆ</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ê²°ì œ / í™˜ë¶ˆ ê¸ˆì•¡</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ê²°ì œìˆ˜ë‹¨</th>
                                        <th class="px-6 py-3 font-medium text-gray-500">ê²°ì œìƒíƒœ</th>
                                        <th class="px-6 py-3 font-medium text-gray-500">ê´€ë¦¬</th>
                                    </tr>
                                </thead>
                                <tbody id="payment-table-body" class="divide-y divide-gray-200">
                                    <!-- Table rows will be inserted here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>


        <!-- Refund Modal -->
        <div id="refund-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-96 shadow-xl">
                <h3 class="text-lg font-bold mb-4 text-gray-900">í™˜ë¶ˆ ì²˜ë¦¬</h3>
                <p class="text-sm text-gray-600 mb-4">ì„ íƒí•œ ê²°ì œ ê±´ì„ í™˜ë¶ˆ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>

                <div class="bg-gray-50 p-3 rounded mb-4 text-sm space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-500">êµ¬ë§¤ì</span>
                        <span id="modal-email" class="font-medium text-gray-900"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">ìƒí’ˆëª…</span>
                        <span id="modal-item" class="font-medium text-gray-900"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">í™˜ë¶ˆ íšŸìˆ˜</span>
                        <div class="flex items-center gap-1">
                            <input type="number" id="modal-count-input"
                                class="text-right border border-gray-300 rounded px-2 py-1 w-20 font-medium text-gray-900 focus:outline-none focus:border-blue-500">
                            <span class="text-gray-500 text-xs">íšŒ</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">í™˜ë¶ˆê¸ˆì•¡</span>
                        <input type="number" id="modal-amount-input"
                            class="text-right border border-gray-300 rounded px-2 py-1 w-40 font-medium text-red-600 focus:outline-none focus:border-red-500">
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">í™˜ë¶ˆ ì‹ ì²­ì</span>
                        <span id="modal-requester" class="font-medium text-gray-900">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">í™˜ë¶ˆ ì‹ ì²­ì¼ì‹œ</span>
                        <span id="modal-request-date" class="font-medium text-gray-900">-</span>
                    </div>
                </div>

                <div class="flex justify-end gap-2">
                    <button onclick="closeRefundModal()"
                        class="px-4 py-2 bg-white text-gray-600 border border-gray-300 rounded hover:bg-gray-50">ì·¨ì†Œ</button>
                    <button onclick="handleRefundAction()"
                        class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">í™˜ë¶ˆ í™•ì •</button>
                </div>
            </div>
        </div>

        <script>
            // Mock Data
            let payments = [
                {
                    email: "user01@example.com",
                    phone: "010-1234-5678",
                    purchaseDate: "2024-01-20 10:30:00",
                    item: "1pass", // 1íšŒ ì´ìš©ê¶Œ
                    itemName: "1íšŒ ì´ìš©ê¶Œ",
                    amount: 30000,
                    method: "ì‹ ìš©ì¹´ë“œ",
                    remainingObj: { total: 1, used: 0 },
                    status: "completed"
                },
                {
                    email: "user02@example.com",
                    phone: "010-9876-5432",
                    purchaseDate: "2024-01-19 15:45:00",
                    item: "5pass", // 5íšŒ ì´ìš©ê¶Œ
                    itemName: "5íšŒ ì´ìš©ê¶Œ",
                    amount: 140000,
                    method: "ì¹´ì¹´ì˜¤í˜ì´",
                    remainingObj: { total: 5, used: 1 },
                    status: "completed"
                },
                {
                    email: "user03@example.com",
                    phone: "010-5555-4444",
                    purchaseDate: "2024-01-18 09:12:00",
                    item: "free", // ë¬´ë£Œ 1íšŒì›
                    itemName: "ë¬´ë£Œ 1íšŒì›",
                    amount: 0,
                    method: "-",
                    remainingObj: { total: 1, used: 1 },
                    status: "completed"
                },
                {
                    email: "user04@example.com",
                    phone: "010-1111-2222",
                    purchaseDate: "2024-01-20 11:00:00",
                    item: "1pass",
                    itemName: "1íšŒ ì´ìš©ê¶Œ",
                    amount: 30000,
                    method: "ì‹ ìš©ì¹´ë“œ",
                    remainingObj: { total: 1, used: 0 },
                    status: "failed"
                },
                {
                    email: "james@zikim.com",
                    phone: "010-7777-8888",
                    purchaseDate: "2024-01-15 14:20:00",
                    item: "5pass",
                    itemName: "5íšŒ ì´ìš©ê¶Œ",
                    amount: 140000,
                    method: "ë„¤ì´ë²„í˜ì´",
                    remainingObj: { total: 5, used: 3 },
                    status: "refund_requested",
                    refundRequester: "í™ê¸¸ë™",
                    refundRequestDate: "2024-01-27 10:00:00"
                },
                {
                    email: "refunded@example.com",
                    phone: "010-1111-3333",
                    purchaseDate: "2024-01-14 11:20:00",
                    item: "1pass",
                    itemName: "1íšŒ ì´ìš©ê¶Œ",
                    amount: 30000,
                    method: "ì‹ ìš©ì¹´ë“œ",
                    remainingObj: { total: 0, used: 0 },
                    status: "refunded",
                    refundedCount: 1,
                    refundRequester: "ê´€ë¦¬ì",
                    refundRequestDate: "2024-01-15 09:30:00",
                    refundAmount: 30000,
                    refundedCount: 1
                }
            ];

            // Elements
            const tableBody = document.getElementById('payment-table-body');
            const filterEmail = document.getElementById('filter-email');
            const filterPhone = document.getElementById('filter-phone');
            const filterDateStart = document.getElementById('filter-date-start');
            const filterDateEnd = document.getElementById('filter-date-end');
            const filterItem = document.getElementById('filter-item');
            const filterStatus = document.getElementById('filter-status');

            // Status Card Elements
            const statPaid = document.getElementById('stat-paid');
            const statFree = document.getElementById('stat-free');
            const statRefundReq = document.getElementById('stat-refund-req');
            const statRefunded = document.getElementById('stat-refunded');
            const statFailed = document.getElementById('stat-failed');

            // Masking Functions
            function maskEmail(email) {
                if (!email) return '';
                const parts = email.split('@');
                if (parts.length < 2) return email;
                const id = parts[0];
                const domain = parts[1];
                if (id.length <= 2) return id + '@' + domain;
                return id.substring(0, 2) + '*'.repeat(id.length - 2) + '@' + domain;
            }

            function maskPhoneNumber(phone) {
                if (!phone) return '';
                // Assume 010-XXXX-XXXX format
                const parts = phone.split('-');
                if (parts.length === 3) {
                    return `${parts[0]}-****-${parts[2]}`;
                }
                return phone;
            }

            // Functions
            function updateStatusCards(filteredData) {
                let paid = 0;
                let free = 0;
                let refundReq = 0;
                let refunded = 0;
                let failed = 0;

                filteredData.forEach(p => {
                    // Paid: Status completed AND Amount > 0
                    if (p.status === 'completed' && p.amount > 0) {
                        paid++;
                    }
                    // Free: Amount is 0 (regardless of status, but usually completed)
                    // Or strictly Check status? Let's follow plan: Amount == 0
                    if (p.amount === 0) {
                        free++;
                    }
                    // Refund Request
                    if (p.status === 'refund_requested') {
                        refundReq++;
                    }
                    // Refund Completed
                    if (p.status === 'refunded') {
                        refunded++;
                    }
                    // Failed
                    if (p.status === 'failed') {
                        failed++;
                    }
                });

                statPaid.textContent = paid.toLocaleString();
                statFree.textContent = free.toLocaleString();
                statRefundReq.textContent = refundReq.toLocaleString();
                statRefunded.textContent = refunded.toLocaleString();
                statFailed.textContent = failed.toLocaleString();
            }

            function renderTable() {
                const fEmail = filterEmail.value.toLowerCase();
                const fPhone = filterPhone.value.replace(/-/g, ''); // Search without dashes
                const fDateStart = filterDateStart.value;
                const fDateEnd = filterDateEnd.value;
                const fItem = filterItem.value;
                const fStatus = filterStatus.value;

                // 1. Base Filter (For Status Cards) - Filters EVERYTHING EXCEPT STATUS
                const baseFiltered = payments.filter(p => {
                    // Email Filter
                    if (fEmail && !p.email.toLowerCase().includes(fEmail)) return false;

                    // Phone Filter
                    if (fPhone && !p.phone.replace(/-/g, '').includes(fPhone)) return false;

                    // Date Range Filter
                    const pDate = p.purchaseDate.split(' ')[0]; // YYYY-MM-DD
                    if (fDateStart && pDate < fDateStart) return false;
                    if (fDateEnd && pDate > fDateEnd) return false;

                    // Item Filter
                    if (fItem !== 'all' && p.item !== fItem) return false;

                    return true;
                });

                // Update Status Cards with base filtered data (before status filter)
                updateStatusCards(baseFiltered);

                // 2. Table Filter - Apply Status Filter on top of base
                const filtered = baseFiltered.filter(p => {
                    if (fStatus !== 'all' && p.status !== fStatus) return false;
                    return true;
                });

                tableBody.innerHTML = '';

                if (filtered.length === 0) {
                    tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                            ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                    return;
                }

                filtered.forEach(p => {
                    let badgeClass = '';
                    let badgeText = '';
                    if (p.status === 'completed') {
                        badgeClass = 'bg-green-100 text-green-800';
                        badgeText = 'ì™„ë£Œ';
                    } else if (p.status === 'failed') {
                        badgeClass = 'bg-red-100 text-red-800';
                        badgeText = 'ì‹¤íŒ¨';
                    } else if (p.status === 'refunded') {
                        badgeClass = 'bg-gray-100 text-gray-800';
                        badgeText = 'í™˜ë¶ˆ ì™„ë£Œ';
                    } else if (p.status === 'refund_requested') {
                        badgeClass = 'bg-orange-100 text-orange-800';
                        badgeText = 'í™˜ë¶ˆ ì‹ ì²­';
                    }

                    const remaining = p.remainingObj.total - p.remainingObj.used;
                    const remainingText = `
                        <div class="flex flex-col items-center">
                            <span class="font-medium ${remaining > 0 ? 'text-blue-600' : 'text-gray-500'}">${remaining}íšŒ</span>
                            <span class="text-xs text-gray-400">${p.refundedCount || 0}íšŒ</span>
                        </div>
                    `;

                    const refundAmtText = p.refundAmount ? p.refundAmount.toLocaleString() + 'ì›' : '-';
                    const amountText = `
                        <div class="flex flex-col items-center">
                            <span class="text-gray-900">${p.amount.toLocaleString()}ì›</span>
                            <span class="text-xs text-red-500">${p.refundAmount ? refundAmtText : ''}</span>
                        </div>
                    `;

                    let actionBtn = '-';
                    const idx = payments.indexOf(p);

                    if (p.status === 'completed' && p.amount > 0) {
                        actionBtn = `<button onclick="requestRefund(${idx})" class="px-3 py-1 text-xs font-medium text-red-600 border border-red-200 rounded hover:bg-red-50">í™˜ë¶ˆ ì‹ ì²­</button>`;
                    } else if (p.status === 'refund_requested') {
                        actionBtn = `
                            <div class="flex gap-1 justify-center">
                                <button onclick="openRefundConfirmModal(${idx})" class="px-2 py-1 text-xs font-medium text-white bg-red-600 rounded hover:bg-red-700">í™•ì •</button>
                                <button onclick="cancelRefundRequest(${idx})" class="px-2 py-1 text-xs font-medium text-gray-600 border border-gray-200 rounded hover:bg-gray-50">ì·¨ì†Œ</button>
                            </div>
                        `;
                    } else if (p.status === 'refunded') {
                        actionBtn = `<button onclick="openRefundDetailModal(${idx})" class="px-3 py-1 text-xs font-medium text-gray-600 border border-gray-200 rounded hover:bg-gray-50">ë‚´ì—­ ë³´ê¸°</button>`;
                    }

                    const row = `
                    <tr class="hover:bg-gray-50/50 transition-colors">
                        <td class="px-6 py-4 font-medium text-gray-900">${maskEmail(p.email)}</td>
                        <td class="px-6 py-4 text-gray-500">${maskPhoneNumber(p.phone)}</td>
                        <td class="px-6 py-4 text-gray-500">${p.purchaseDate}</td>
                        <td class="px-6 py-4"><span class="font-medium">${p.itemName}</span></td>
                        <td class="px-6 py-4">${remainingText}</td>
                        <td class="px-6 py-4">${amountText}</td>
                        <td class="px-6 py-4 text-gray-500">${p.method}</td>
                        <td class="px-6 py-4"><span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent ${badgeClass}">${badgeText}</span></td>
                        <td class="px-6 py-4 text-center">${actionBtn}</td>
                    </tr>
                `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            // Refund Logic
            let currentRefundIndex = -1;
            let currentModalMode = ''; // 'REQUEST', 'CONFIRM', 'DETAIL'
            const CURRENT_ADMIN = 'manager_01'; // Mock Admin ID

            const refundModal = document.getElementById('refund-modal');
            const modalTitle = refundModal.querySelector('h3');
            const modalDesc = refundModal.querySelector('p');
            const confirmBtn = refundModal.querySelector('button.bg-red-600');
            const cancelBtn = refundModal.querySelector('button.bg-white'); // Updated selector for new cancel button class

            // Consolidated Modal Function
            window.openRefundModal = function (index, mode) {
                currentRefundIndex = index;
                currentModalMode = mode;
                const p = payments[index];

                refundModal.classList.remove('hidden');
                refundModal.classList.add('flex');
                confirmBtn.classList.remove('hidden');
                cancelBtn.innerText = 'ì·¨ì†Œ';
                cancelBtn.onclick = closeRefundModal;

                // Common Data
                document.getElementById('modal-email').innerText = p.email;
                document.getElementById('modal-item').innerText = p.itemName;

                // Refund Amount Input handling
                const amountInput = document.getElementById('modal-amount-input');
                amountInput.value = p.refundAmount || p.amount; // Use saved refund amount or default to full amount
                amountInput.disabled = false; // Default to editable
                amountInput.classList.remove('bg-gray-100', 'text-gray-500'); // Reset styles

                // Refund Count Input handling
                const countInput = document.getElementById('modal-count-input');
                const remaining = p.remainingObj.total - p.remainingObj.used;
                countInput.value = p.refundedCount || remaining; // Use saved refund count or default to remaining
                countInput.disabled = false;
                countInput.classList.remove('bg-gray-100', 'text-gray-500');

                // Reset confirm button classes before applying mode-specific ones
                confirmBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');

                // Helper to get formatted Time
                const getNow = () => {
                    const now = new Date();
                    const Y = now.getFullYear();
                    const M = String(now.getMonth() + 1).padStart(2, '0');
                    const D = String(now.getDate()).padStart(2, '0');
                    const h = String(now.getHours()).padStart(2, '0');
                    const m = String(now.getMinutes()).padStart(2, '0');
                    const s = String(now.getSeconds()).padStart(2, '0');
                    return `${Y}-${M}-${D} ${h}:${m}:${s}`;
                };

                if (mode === 'REQUEST') {
                    modalTitle.innerText = 'í™˜ë¶ˆ ì‹ ì²­';
                    modalDesc.innerText = 'í•´ë‹¹ ê²°ì œ ê±´ì— ëŒ€í•´ í™˜ë¶ˆì„ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                    confirmBtn.innerText = 'ì‹ ì²­ ì™„ë£Œ';
                    confirmBtn.classList.replace('bg-red-600', 'bg-orange-500');
                    confirmBtn.classList.replace('hover:bg-red-700', 'hover:bg-orange-600');
                    // Show current admin as requester
                    document.getElementById('modal-requester').innerText = CURRENT_ADMIN;
                    // Show current time as request date
                    document.getElementById('modal-request-date').innerText = getNow() + ' (ì˜ˆì •)';
                }
                else if (mode === 'CONFIRM') {
                    modalTitle.innerText = 'í™˜ë¶ˆ í™•ì •';
                    modalDesc.innerText = 'ì„ íƒí•œ ê²°ì œ ê±´ì˜ í™˜ë¶ˆì„ ìµœì¢… í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì¬ë¬´íŒ€ ìŠ¹ì¸ ì™„ë£Œ)';
                    confirmBtn.innerText = 'í™˜ë¶ˆ í™•ì •';
                    // Classes are already red by default reset, no need to replace
                    document.getElementById('modal-requester').innerText = p.refundRequester;
                    document.getElementById('modal-request-date').innerText = p.refundRequestDate || '-';
                }
                else if (mode === 'DETAIL') {
                    modalTitle.innerText = 'í™˜ë¶ˆ ì™„ë£Œ ë‚´ì—­';
                    modalDesc.innerText = 'ì´ë¯¸ í™˜ë¶ˆ ì²˜ë¦¬ê°€ ì™„ë£Œëœ ê±´ì…ë‹ˆë‹¤.';
                    confirmBtn.classList.add('hidden');
                    cancelBtn.innerText = 'ë‹«ê¸°';
                    document.getElementById('modal-requester').innerText = p.refundRequester || '-';
                    document.getElementById('modal-request-date').innerText = p.refundRequestDate || '-';

                    // Make input read-only for detail view
                    // Make input read-only for detail view
                    amountInput.disabled = true;
                    amountInput.classList.add('bg-gray-100', 'text-gray-500');
                    countInput.disabled = true;
                    countInput.classList.add('bg-gray-100', 'text-gray-500');
                }
            }

            window.handleRefundAction = function () {
                if (currentRefundIndex === -1) return;

                const amountInput = document.getElementById('modal-amount-input');
                const countInput = document.getElementById('modal-count-input');
                const refundAmt = parseInt(amountInput.value) || 0;
                const refundCnt = parseInt(countInput.value) || 0;

                payments[currentRefundIndex].refundAmount = refundAmt;
                payments[currentRefundIndex].refundedCount = refundCnt; // Save proposed/final refund count

                if (currentModalMode === 'REQUEST') {
                    const now = new Date();
                    const formattedDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

                    payments[currentRefundIndex].status = 'refund_requested';
                    payments[currentRefundIndex].refundRequester = CURRENT_ADMIN;
                    payments[currentRefundIndex].refundRequestDate = formattedDate;
                    alert('í™˜ë¶ˆ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else if (currentModalMode === 'CONFIRM') {
                    const p = payments[currentRefundIndex];

                    payments[currentRefundIndex].status = 'refunded';
                    // Decrease total by refunded count to reflect deduction in remaining
                    payments[currentRefundIndex].remainingObj.total -= refundCnt;

                    alert('í™˜ë¶ˆ ì²˜ë¦¬ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }

                renderTable();
                closeRefundModal();
            }

            window.closeRefundModal = function () {
                refundModal.classList.add('hidden');
                refundModal.classList.remove('flex');
                currentRefundIndex = -1;
                currentModalMode = ''; // Reset mode
                // Reset styling just in case
                confirmBtn.classList.replace('bg-orange-500', 'bg-red-600');
                confirmBtn.classList.replace('hover:bg-orange-600', 'hover:bg-red-700');
            }

            // Wrapper functions to match onclicks
            window.requestRefund = function (index) {
                openRefundModal(index, 'REQUEST');
            }

            window.openRefundConfirmModal = function (index) {
                openRefundModal(index, 'CONFIRM');
            }

            window.openRefundDetailModal = function (index) {
                openRefundModal(index, 'DETAIL');
            }

            // 2. Cancel Refund Request (No change needed, keeps simple confirm)
            window.cancelRefundRequest = function (index) {
                if (confirm('í™˜ë¶ˆ ì‹ ì²­ì„ ì·¨ì†Œí•˜ê³  ê²°ì œ ì™„ë£Œ ìƒíƒœë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    payments[index].status = 'completed';
                    delete payments[index].refundRequester; // Clear requester
                    delete payments[index].refundAmount; // Clear refund amount
                    delete payments[index].refundRequestDate; // Clear request date
                    renderTable();
                }
            }

            // Event Listeners
            filterEmail.addEventListener('input', renderTable);
            filterPhone.addEventListener('input', renderTable);
            filterDateStart.addEventListener('input', renderTable);
            filterDateEnd.addEventListener('input', renderTable);
            filterItem.addEventListener('change', renderTable);
            filterStatus.addEventListener('change', renderTable);

            // Initial Render
            renderTable();

        </script>
    </div>
</body>

</html>